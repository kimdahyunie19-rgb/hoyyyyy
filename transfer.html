<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TLGP WMS ‚Äî Transfer In</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
    <!-- SheetJS for Excel parsing -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
    /* ‚îÄ‚îÄ PRINT STYLES ‚îÄ‚îÄ */
    @media print {
        body > * { display: none !important; }
        #transfer-print-area { display: block !important; }
        .print-close-transfer { display: none !important; }
    }
    #transfer-print-area { display:none; position:fixed; inset:0; z-index:99999; background:#fff; overflow:auto; }

    /* TAG PRINT */
    .tag-page { width:284.3mm; height:197.3mm; margin:0 auto; background:#fff; font-family:Arial,sans-serif; color:#000; box-sizing:border-box; padding:0; page-break-after:always; display:flex; flex-direction:column; overflow:hidden; }
    .tag-page:last-child { page-break-after:avoid; }
    .tag-company { font-size:14pt;font-weight:bold;padding:2mm 3mm;border-left:2.5px solid #000;border-top:2.5px solid #000;border-right:2.5px solid #000;line-height:1.2;flex-shrink:0; }
    .tag-title-row { font-size:20pt;font-weight:bold;text-align:center;border-left:2.5px solid #000;border-right:2.5px solid #000;padding:2mm 3mm;letter-spacing:2px;flex-shrink:0; }
    .tag-field { display:flex;border-left:2.5px solid #000;border-right:2.5px solid #000;flex:1;min-height:0; }
    .tag-field + .tag-field, .tag-title-row + .tag-field { border-top:1px solid #ccc; }
    .tag-field-label { font-size:14pt;font-weight:bold;padding:2mm 3mm;display:flex;align-items:center;width:42mm;flex-shrink:0;line-height:1.2; }
    .tag-field-value { font-size:80pt;display:flex;align-items:center;justify-content:center;flex:1;text-align:center;overflow:hidden;line-height:1;word-break:break-all; }
    .tag-field-value.bold { font-weight:bold; }
    .tag-footer { border:2.5px solid #000;border-top:1px solid #ccc;padding:1mm 3mm;display:flex;justify-content:flex-end;flex-shrink:0; }
    .tag-doc-ref { font-size:11pt;font-weight:bold; }

    /* SLIP PRINT ‚Äî A4 LANDSCAPE, bordered layout matching reference */
    @page { size: A4 landscape; margin: 8mm 10mm; }
    * { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }

    .slip-print-page {
        width: 277mm; max-width: 277mm; margin: 0 auto;
        background: #fff; font-family: Arial, Helvetica, sans-serif;
        font-size: 8pt; color: #000; box-sizing: border-box;
    }
    /* ‚îÄ‚îÄ TOP HEADER (outside border) ‚îÄ‚îÄ */
    .sp-header { display:flex; align-items:flex-end; justify-content:space-between; margin-bottom:1.5mm; }
    .sp-header-left { display:flex; flex-direction:column; gap:0.5mm; min-width:60mm; }
    .sp-company-logo { display:flex; align-items:center; gap:2mm; margin-bottom:0.5mm; }
    .sp-logo-s { width:6mm; height:6mm; background:#c00; border-radius:50%; display:flex; align-items:center; justify-content:center; color:#fff; font-size:8.5pt; font-weight:900; font-style:italic; flex-shrink:0; }
    .sp-company-name { font-size:7pt; font-weight:700; line-height:1.3; }
    .sp-company-sub  { font-size:5.5pt; color:#555; font-style:italic; }
    .sp-from-to { display:flex; flex-direction:column; gap:0.8mm; margin-top:1mm; }
    .sp-from-to-row { font-size:7.5pt; font-weight:600; display:flex; align-items:baseline; gap:1.5mm; }
    .sp-from-to-lbl { font-weight:700; min-width:8mm; }
    .sp-from-to-val { border-bottom:1px solid #000; min-width:30mm; padding-bottom:0.5mm; font-size:7.5pt; }
    .sp-header-center { text-align:center; flex:1; padding:0 3mm; }
    .sp-title { font-size:22pt; font-weight:900; letter-spacing:2px; color:#000; line-height:1; }
    .sp-header-right { display:flex; flex-direction:column; align-items:flex-end; gap:2mm; min-width:60mm; justify-content:flex-end; }
    .sp-ctrl-row { display:flex; align-items:baseline; gap:2mm; }
    .sp-ctrl-lbl { font-size:7.5pt; font-weight:700; white-space:nowrap; }
    .sp-ctrl-val { font-size:9pt; font-weight:900; font-family:'Courier New',monospace; border-bottom:1.5px solid #000; min-width:42mm; text-align:left; padding-bottom:0.5mm; }

    /* ‚îÄ‚îÄ MAIN BORDERED BOX ‚îÄ‚îÄ */
    .sp-box { border:1.5px solid #000; width:100%; box-sizing:border-box; }
    .sp-date-row { display:flex; align-items:center; gap:3mm; padding:1.5mm 3mm; border-bottom:1px solid #888; font-size:7.5pt; font-weight:700; }
    .sp-date-lbl { font-weight:700; white-space:nowrap; }
    .sp-date-val { border-bottom:1px solid #000; min-width:35mm; display:inline-block; }

    /* ‚îÄ‚îÄ TABLE inside box ‚îÄ‚îÄ */
    .sp-table { width:100%; border-collapse:collapse; font-size:7pt; table-layout:fixed; }
    .sp-table thead th {
        background:#c8c8c8; border:1px solid #555;
        padding:2.5px 2px; font-size:6.5pt; font-weight:700;
        text-align:center; vertical-align:middle;
        white-space:normal; word-break:break-word; line-height:1.2;
    }
    .sp-table tbody td {
        border:1px solid #bbb; padding:2px 2.5px;
        font-size:7pt; text-align:center; vertical-align:middle;
        word-break:break-word; line-height:1.2;
    }
    .sp-table tbody td.l { text-align:left; }
    .sp-table tbody td.r { text-align:right; font-weight:600; }
    .sp-table tbody tr:nth-child(even) td { background:#f5f5f5; }
    .sp-table tfoot td { font-weight:900; background:#e0e0e0; border:1.5px solid #444; padding:2px 3px; font-size:7.5pt; }

    /* ‚îÄ‚îÄ BELOW BOX ‚îÄ‚îÄ */
    .sp-note  { font-size:6.5pt; color:#444; margin-top:2mm; font-style:italic; }
    .sp-sigs  { display:flex; justify-content:space-between; margin-top:5mm; gap:8mm; }
    .sp-sig   { flex:1; display:flex; flex-direction:column; gap:4mm; }
    .sp-sig-lbl  { font-size:7.5pt; font-weight:700; }
    .sp-sig-line { border-top:1.5px solid #000; width:100%; }
    .sp-footer   { text-align:right; margin-top:2mm; font-size:6.5pt; color:#888; font-style:italic; }
    .print-close-transfer { position:fixed;top:12px;right:16px;z-index:999999;background:#dc2626;color:#fff;border:none;border-radius:6px;padding:10px 18px;font-size:13px;font-weight:700;cursor:pointer; }

    /* ‚îÄ‚îÄ EXCEL UPLOAD PANEL ‚îÄ‚îÄ */
    .upload-panel { margin:8px 10px 4px; background:#f0fdf4; border:1.5px solid #bbf7d0; border-radius:8px; padding:10px; }
    .upload-panel-title { font-size:9px;font-weight:800;color:#15803d;letter-spacing:0.12em;text-transform:uppercase;margin-bottom:6px; }
    .upload-dropzone {
        border:2px dashed #86efac; border-radius:7px; background:#fff;
        text-align:center; padding:14px 10px; cursor:pointer; transition:0.18s;
        position:relative; margin-bottom:7px;
    }
    .upload-dropzone:hover, .upload-dropzone.drag-over {
        border-color:#16a34a; background:#f0fdf4;
    }
    .upload-dropzone input[type=file] {
        position:absolute; inset:0; opacity:0; cursor:pointer; width:100%; height:100%;
    }
    .upload-icon { font-size:22px; margin-bottom:4px; }
    .upload-text { font-size:10px; font-weight:700; color:#15803d; }
    .upload-hint { font-size:8.5px; color:#6b7280; margin-top:2px; }
    .upload-file-name {
        font-size:9px; font-weight:600; color:#1e293b;
        background:#dcfce7; border:1px solid #86efac; border-radius:4px;
        padding:4px 8px; margin-bottom:6px; display:none;
        word-break:break-all; font-family:'JetBrains Mono',monospace;
    }
    .upload-col-hint {
        font-size:8px; color:#475569; background:#f0fdf4; border:1px solid #bbf7d0;
        border-radius:4px; padding:5px 7px; margin-bottom:7px; line-height:1.7;
    }
    .upload-col-hint b { color:#15803d; }
    .btn-upload-parse {
        width:100%; padding:9px; background:linear-gradient(135deg,#16a34a,#15803d);
        border:none; border-radius:6px; color:#fff; font-size:11px; font-weight:800;
        cursor:pointer; font-family:inherit; letter-spacing:0.04em; transition:0.15s;
        display:flex; align-items:center; justify-content:center; gap:6px;
    }
    .btn-upload-parse:hover { opacity:0.9; box-shadow:0 3px 12px rgba(22,163,74,0.3); }
    .btn-upload-parse:disabled { opacity:0.5; cursor:not-allowed; }
    .upload-result { margin-top:6px; font-size:10px; font-weight:600; padding:5px 8px; border-radius:4px; display:none; }
    .upload-result.ok  { background:#d1fae5; color:#059669; }
    .upload-result.err { background:#fee2e2; color:#dc2626; }

    /* ‚îÄ‚îÄ REVIEW MODAL ‚îÄ‚îÄ */
    .review-modal-overlay {
        position:fixed; inset:0; background:rgba(15,23,42,0.55);
        display:none; align-items:center; justify-content:center;
        z-index:2000; backdrop-filter:blur(4px);
    }
    .review-modal-overlay.open { display:flex; }
    .review-modal-box {
        background:#fff; border-radius:14px; box-shadow:0 24px 80px rgba(15,23,42,0.2);
        width:96vw; max-width:1380px; height:90vh;
        display:flex; flex-direction:column; border:1px solid #e2e8f0; overflow:hidden;
    }
    .review-header {
        padding:14px 20px; background:linear-gradient(135deg,#1d4ed8,#2563eb);
        display:flex; align-items:center; justify-content:space-between; flex-shrink:0;
    }
    .review-header-left { display:flex; flex-direction:column; gap:2px; }
    .review-header-title { font-size:15px; font-weight:800; color:#fff; letter-spacing:0.06em; }
    .review-header-sub { font-size:9px; color:rgba(255,255,255,0.65); letter-spacing:0.1em; }
    .review-header-close {
        background:rgba(255,255,255,0.15); border:1.5px solid rgba(255,255,255,0.35);
        border-radius:7px; color:#fff; font-size:12px; font-weight:700;
        padding:7px 14px; cursor:pointer; transition:0.15s; font-family:inherit;
    }
    .review-header-close:hover { background:rgba(255,255,255,0.28); }
    .review-stats-bar {
        display:flex; gap:0; background:#f8fafc; border-bottom:1.5px solid #e2e8f0;
        flex-shrink:0;
    }
    .review-stat {
        padding:10px 18px; display:flex; flex-direction:column; gap:2px;
        border-right:1px solid #e2e8f0; flex:1;
    }
    .review-stat-val { font-size:18px; font-weight:800; color:#1e293b; }
    .review-stat-lbl { font-size:8px; font-weight:700; color:#94a3b8; letter-spacing:0.1em; }
    .review-stat.ok .review-stat-val   { color:#059669; }
    .review-stat.warn .review-stat-val { color:#d97706; }
    .review-stat.err .review-stat-val  { color:#dc2626; }
    .review-legend {
        padding:8px 20px; background:#fffbeb; border-bottom:1px solid #fde68a;
        font-size:10px; color:#92400e; display:flex; align-items:center; gap:14px; flex-shrink:0;
    }
    .review-legend b { font-weight:800; }
    .legend-dot { display:inline-block; width:10px; height:10px; border-radius:2px; margin-right:3px; vertical-align:middle; }
    .review-table-wrap { flex-grow:1; overflow:auto; }
    .review-table {
        width:100%; border-collapse:collapse; font-size:11px;
        font-family:'DM Sans','Segoe UI',Arial,sans-serif;
    }
    .review-table thead th {
        background:#f1f5f9; color:#64748b; font-size:9px; font-weight:700;
        letter-spacing:0.1em; padding:9px 8px; text-align:center;
        position:sticky; top:0; z-index:5; border-bottom:2px solid #e2e8f0;
        white-space:nowrap; font-family:'JetBrains Mono',monospace;
    }
    .review-table td {
        padding:6px 8px; border-bottom:1px solid #f1f5f9;
        text-align:center; color:#374151; white-space:nowrap;
    }
    .review-table tr:hover td { background:#f8fafc; }
    .review-table tr.row-conflict td { background:#fef9c3; }
    .review-table tr.row-ok td { background:#f0fdf4; }
    .review-loc-input {
        background:#fff; border:1.5px solid #e2e8f0; border-radius:4px;
        color:#dc2626; font-size:11px; font-weight:700; padding:4px 7px;
        font-family:'JetBrains Mono',monospace; width:90px; outline:none;
        text-transform:uppercase; transition:0.14s;
    }
    .review-loc-input:focus { border-color:#2563eb; box-shadow:0 0 0 2px rgba(37,99,235,0.1); }
    .review-loc-input.conflict { border-color:#f59e0b; background:#fef9c3; }
    .review-loc-input.vacant   { border-color:#16a34a; background:#f0fdf4; }
    .row-num-cell { color:#94a3b8; font-family:'JetBrains Mono',monospace; font-size:10px; font-weight:500; }
    .status-chip {
        display:inline-block; padding:2px 7px; border-radius:4px;
        font-size:8.5px; font-weight:700; letter-spacing:0.05em;
        font-family:'JetBrains Mono',monospace; white-space:nowrap;
    }
    .chip-passed  { background:#d1fae5; color:#059669; border:1px solid #6ee7b7; }
    .chip-hold    { background:#fef3c7; color:#d97706; border:1px solid #fcd34d; }
    .chip-underqa { background:#ede9fe; color:#7c3aed; border:1px solid #c4b5fd; }
    .chip-failed  { background:#fee2e2; color:#dc2626; border:1px solid #fca5a5; }
    .chip-default { background:#f1f5f9; color:#64748b; border:1px solid #e2e8f0; }
    .review-footer {
        padding:12px 20px; background:#f8fafc; border-top:2px solid #e2e8f0;
        display:flex; align-items:center; justify-content:space-between; flex-shrink:0;
        gap:12px;
    }
    .review-footer-note { font-size:10px; color:#6b7280; }
    .review-footer-actions { display:flex; gap:8px; align-items:center; }
    .btn-review-cancel {
        padding:10px 20px; background:#f9fafb; border:1px solid #e2e8f0;
        border-radius:7px; color:#6b7280; font-size:12px; font-weight:700;
        cursor:pointer; font-family:inherit; transition:0.15s;
    }
    .btn-review-cancel:hover { background:#374151; color:#fff; }
    .btn-review-confirm {
        padding:10px 24px; background:linear-gradient(135deg,#2563eb,#1d4ed8);
        border:none; border-radius:7px; color:#fff; font-size:12px; font-weight:800;
        cursor:pointer; font-family:inherit; letter-spacing:0.04em; transition:0.15s;
        display:flex; align-items:center; gap:7px;
    }
    .btn-review-confirm:hover { box-shadow:0 5px 20px rgba(37,99,235,0.3); transform:translateY(-1px); }
    .btn-review-reassign {
        padding:8px 14px; background:#f0fdf4; border:1.5px solid #86efac;
        border-radius:6px; color:#16a34a; font-size:11px; font-weight:700;
        cursor:pointer; font-family:inherit; transition:0.15s;
    }
    .btn-review-reassign:hover { background:#16a34a; color:#fff; }
    .conflict-badge {
        display:inline-flex; align-items:center; gap:4px;
        background:#fef3c7; color:#d97706; border:1px solid #fcd34d;
        border-radius:4px; padding:2px 7px; font-size:8.5px; font-weight:700;
        font-family:'JetBrains Mono',monospace;
    }
    .ok-badge {
        display:inline-flex; align-items:center; gap:4px;
        background:#d1fae5; color:#059669; border:1px solid #6ee7b7;
        border-radius:4px; padding:2px 7px; font-size:8.5px; font-weight:700;
        font-family:'JetBrains Mono',monospace;
    }

    /* reuse existing bulk-col-hint for upload hints */
    .bulk-col-hint { font-size:8.5px;color:#475569;background:#dbeafe;border-radius:4px;padding:5px 7px;margin-bottom:7px;line-height:1.6; }
    .bulk-col-hint b { color:#1d4ed8; }

    /* ‚îÄ‚îÄ BULK IMPORT SIDEBAR PANEL ‚îÄ‚îÄ */
    .bulk-panel { margin:8px 10px 4px; background:#eff6ff; border:1.5px solid #bfdbfe; border-radius:8px; padding:10px; }
    .bulk-panel-title { font-size:9px;font-weight:800;color:#1d4ed8;letter-spacing:0.12em;text-transform:uppercase;margin-bottom:5px; }
    .bulk-xl-area { width:100%;height:88px;background:#fff;border:1.5px solid #93c5fd;border-radius:5px;color:#1e293b;font-family:'JetBrains Mono','Courier New',monospace;font-size:10px;padding:7px 8px;resize:vertical;outline:none;transition:0.15s;line-height:1.4; }
    .bulk-xl-area:focus { border-color:#2563eb; }
    .bulk-xl-area::placeholder { color:#94a3b8;font-size:9px; }
    .btn-bulk-process { width:100%;margin-top:7px;padding:9px;background:linear-gradient(135deg,#2563eb,#1d4ed8);border:none;border-radius:6px;color:#fff;font-size:11px;font-weight:800;cursor:pointer;font-family:inherit;letter-spacing:0.04em;transition:0.15s; }
    .btn-bulk-process:hover { opacity:0.9;box-shadow:0 3px 12px rgba(37,99,235,0.3); }
    .bulk-result { margin-top:6px;font-size:10px;font-weight:600;padding:5px 8px;border-radius:4px;display:none; }
    .bulk-result.ok  { background:#d1fae5;color:#059669; }
    .bulk-result.err { background:#fee2e2;color:#dc2626; }
    </style>
</head>
<body>

<div id="transfer-print-area"></div>
<button class="print-close-transfer" id="print-close-transfer" style="display:none;" onclick="closePrintSlip()">‚úï CLOSE PRINT</button>

<!-- LOGIN -->
<div id="login-overlay">
    <div class="login-card">
        <div class="login-top"><span class="icon">üì¶</span><h1>TLGP WMS</h1><p>WAREHOUSE MANAGEMENT SYSTEM</p></div>
        <div class="login-body">
            <div class="lf"><label>Email Address</label><input type="text" id="log-email" placeholder="user@company.com" autocomplete="off"></div>
            <div class="lf"><label>Password</label><input type="password" id="log-pass" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"></div>
            <p id="log-err">‚ö† Invalid credentials. Please try again.</p>
            <button class="login-btn" onclick="checkLogin()">LOGIN TO SYSTEM</button>
        </div>
        <div class="login-foot">AUTHORIZED PERSONNEL ONLY</div>
    </div>
</div>

<!-- SIDEBAR -->
<aside class="sidebar" style="width:240px; overflow-y:auto;">
    <div class="sidebar-header">
        <div class="sidebar-icon">üì¶</div>
        <div><span class="brand">TLGP WMS</span><span class="ver">PRO v2.0</span></div>
    </div>
    <div class="sb-sec">
        <span class="sb-lbl">NAVIGATION</span>
        <a class="nav-btn" href="index.html">üì¶ &nbsp;INVENTORY LIST</a>
        <a class="nav-btn active" href="transfer.html">üöö &nbsp;TRANSFER IN</a>
        <a class="nav-btn" href="pullout.html">üì§ &nbsp;PULL-OUT SLIP</a>
        <a class="nav-btn" href="storingtag.html">üè∑ &nbsp;STORING TAG</a>
        <a class="nav-btn" href="history.html">üìú &nbsp;SYSTEM LOGS</a>
    </div>

    <!-- ‚ïê‚ïê EXCEL FILE UPLOAD PANEL ‚ïê‚ïê -->
    <div class="upload-panel">
        <div class="upload-panel-title">üìÇ EXCEL FILE IMPORT</div>

        <div class="upload-col-hint">
            Upload your Excel file ‚Äî column headers are <b>auto-detected</b> (any order, any variation):<br>
            <b>Product/Item Code ¬∑ Lot # ¬∑ Status ¬∑ Qty ¬∑ Cases ¬∑ Expiry ¬∑ Pallet ¬∑ Remarks ¬∑ Date ¬∑ Type ¬∑ DR/Invoice ¬∑ Src Loc ¬∑ Location</b>
        </div>

        <!-- Drop zone -->
        <div class="upload-dropzone" id="upload-dropzone"
             ondragover="event.preventDefault();this.classList.add('drag-over')"
             ondragleave="this.classList.remove('drag-over')"
             ondrop="handleDrop(event)">
            <input type="file" id="excel-file-input" accept=".xlsx,.xls,.csv" onchange="handleFileSelect(event)">
            <div class="upload-icon">üìä</div>
            <div class="upload-text">Click or drag Excel file here</div>
            <div class="upload-hint">.xlsx ¬∑ .xls ¬∑ .csv accepted</div>
        </div>

        <div class="upload-file-name" id="upload-file-name"></div>

        <button class="btn-upload-parse" id="btn-parse-excel" onclick="parseAndReview()" disabled>
            üîç PREVIEW &amp; ASSIGN LOCATIONS
        </button>
        <div id="upload-result" class="upload-result"></div>
    </div>

    <!-- ‚ïê‚ïê EXCEL BULK IMPORT (PASTE) PANEL ‚ïê‚ïê -->
    <div class="bulk-panel">
        <div class="bulk-panel-title">üìã EXCEL BULK IMPORT (PASTE)</div>
        <div class="bulk-col-hint">
            Paste tab-separated rows from Excel:<br>
            <b>Loc ¬∑ Code ¬∑ Lot ¬∑ Status ¬∑ Qty ¬∑ Pallet ¬∑ DR ¬∑ Date ¬∑ Type</b>
        </div>
        <textarea id="xl" class="bulk-xl-area" placeholder="TRA0101&#9;ITEM001&#9;LOT001&#9;PASSED&#9;500&#9;&#9;DR001&#9;2025-01-01&#9;RESIN&#10;TRA0102&#9;ITEM002&#9;LOT002&#9;PASSED&#9;300"></textarea>
        <button class="btn-bulk-process" onclick="impBulk()">‚ö° PROCESS IMPORT</button>
        <div id="bulk-result" class="bulk-result"></div>
    </div>

    <div class="sb-bot">
        <button class="btn-danger" onclick="mr()">‚ö† MASTER RESET</button>
    </div>
</aside>

<!-- REVIEW MODAL -->
<div class="review-modal-overlay" id="review-modal">
    <div class="review-modal-box">
        <div class="review-header">
            <div class="review-header-left">
                <div class="review-header-title">üìã REVIEW IMPORT ‚Äî CONFIRM BEFORE LOADING</div>
                <div class="review-header-sub" id="review-filename-label">Filename: ‚Äî</div>
            </div>
            <button class="review-header-close" onclick="closeReviewModal()">‚úï CANCEL</button>
        </div>

        <!-- Stats bar -->
        <div class="review-stats-bar">
            <div class="review-stat ok">
                <span class="review-stat-val" id="rv-stat-rows">0</span>
                <span class="review-stat-lbl">TOTAL ROWS</span>
            </div>
            <div class="review-stat ok">
                <span class="review-stat-val" id="rv-stat-auto">0</span>
                <span class="review-stat-lbl">AUTO-ASSIGNED LOCS</span>
            </div>
            <div class="review-stat warn">
                <span class="review-stat-val" id="rv-stat-conflict">0</span>
                <span class="review-stat-lbl">LOCATION CONFLICTS</span>
            </div>
            <div class="review-stat">
                <span class="review-stat-val" id="rv-stat-qty">0</span>
                <span class="review-stat-lbl">TOTAL QUANTITY</span>
            </div>
        </div>

        <!-- Legend -->
        <div class="review-legend">
            ‚ö†Ô∏è <b>Review each row carefully.</b> &nbsp;
            <span><span class="legend-dot" style="background:#f0fdf4;border:1px solid #86efac;"></span> Green = vacant location auto-assigned</span>
            <span><span class="legend-dot" style="background:#fef9c3;border:1px solid #fcd34d;"></span> Yellow = location already occupied ‚Äî edit or reassign</span>
            &nbsp;|&nbsp; <b>You can edit any Location field before loading to grid.</b>
        </div>

        <!-- Table -->
        <div class="review-table-wrap">
            <table class="review-table">
                <thead>
                    <tr id="review-thead-row">
                        <th>#</th>
                        <th>LOCATION <span style="font-weight:400;opacity:0.6;">(editable)</span></th>
                        <th>ITEM CODE</th>
                        <th>LOT #</th>
                        <th>STATUS</th>
                        <th>QTY</th>
                        <th>CASES</th>
                        <th>EXPIRY</th>
                        <th>PALLET</th>
                        <th>REMARKS</th>
                        <th>DATE</th>
                        <th>ITEM TYPE</th>
                        <th>DR / INVOICE</th>
                        <th>SRC LOC</th>
                        <th>LOC STATUS</th>
                    </tr>
                </thead>
                <tbody id="review-tbody"></tbody>
            </table>
        </div>

        <!-- Footer -->
        <div class="review-footer">
            <div class="review-footer-note">
                ‚úèÔ∏è After loading to grid, you can still edit any cell before committing to inventory.
            </div>
            <div class="review-footer-actions">
                <button class="btn-review-reassign" onclick="reassignAllConflicts()">‚ôªÔ∏è REASSIGN CONFLICTS</button>
                <button class="btn-review-cancel" onclick="closeReviewModal()">CANCEL</button>
                <button class="btn-review-confirm" onclick="loadReviewToGrid()">
                    ‚úì LOAD TO GRID
                    <span id="rv-load-count" style="background:rgba(255,255,255,0.2);border-radius:4px;padding:1px 7px;font-size:11px;"></span>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- MAIN -->
<main class="main">
<div class="page-content">

    <!-- TRANSFER SLIP HEADER -->
    <div class="ts-slip-card">
        <div class="ts-slip-banner">
            <div class="ts-banner-left">
                <div class="ts-company">Toshiba Logistics Phils. Corp.</div>
                <div class="ts-slip-big-title">TRANSFER SLIP</div>
            </div>
            <div class="ts-banner-right">
                <div class="ts-ctrl-lbl">TS CONTROL NO.</div>
                <input type="text" id="slip-tsno" class="ts-ctrl-no-input" placeholder="TL-YYYYMMDD-XX">
            </div>
        </div>
        <div class="ts-slip-fields">
            <div class="ts-field-group"><span class="ts-field-lbl">FROM</span><span class="ts-field-static">TPC</span></div>
            <div class="ts-field-group"><span class="ts-field-lbl">TO</span><span class="ts-field-static">TLGP</span></div>
            <div class="ts-field-group"><span class="ts-field-lbl">DATE</span><input type="date" id="slip-date" class="ts-field-inp"></div>
            <div class="ts-field-group"><span class="ts-field-lbl">DR / INVOICE</span><input type="text" id="slip-dr" class="ts-field-inp" placeholder="DR or Invoice No."></div>
            <div class="ts-field-group">
                <span class="ts-field-lbl">DEFAULT TYPE</span>
                <select id="slip-typ" class="ts-field-inp" onchange="applySlipType()">
                    <option value="">‚Äî Select ‚Äî</option>
                    <option value="RESIN">RESIN</option><option value="FILM">FILM</option>
                    <option value="MOLDED PARTS">MOLDED PARTS</option><option value="UN-STERILE">UN-STERILE</option>
                    <option value="PACKAGING">PACKAGING</option>
                </select>
            </div>
            <div class="ts-field-group">
                <span class="ts-field-lbl">DEFAULT STATUS</span>
                <select id="slip-sts" class="ts-field-inp">
                    <option value="PASSED">PASSED</option><option value="HOLD">HOLD</option>
                    <option value="UNDER QA">UNDER QA</option><option value="FAILED">FAILED</option>
                </select>
            </div>
        </div>
    </div>

    <!-- TOOLBAR -->
    <div class="page-header" style="padding:8px 14px;gap:8px;">
        <div class="ph-left">
            <h2>üöö TRANSFER IN GRID</h2>
            <span class="log-summary-badge" id="row-count-badge">0 rows</span>
        </div>
        <div class="ph-right" style="flex-wrap:wrap;gap:5px;">
            <button class="btn-xls-action" onclick="addRows(1)">+ 1 ROW</button>
            <button class="btn-xls-action" onclick="addRows(5)">+ 5 ROWS</button>
            <button class="btn-xls-action" onclick="addRows(10)">+ 10 ROWS</button>
            <button class="btn-xls-action" onclick="deleteEmptyRows()">üóë DEL EMPTY</button>
            <button class="btn-xls-action" onclick="deleteSelectedRows()">üóë DEL ROWS</button>
            <button class="btn-xls-action" onclick="showColManager()">‚öô COLUMNS</button>
            <button class="btn-xls-action" onclick="saveGridState()">üíæ SAVE DRAFT</button>
            <button class="btn-xls-action" onclick="clearGrid()">‚úï CLEAR</button>
            <button class="btn-print-slip" onclick="printSlip()">üñ® PRINT SLIP</button>
            <button class="btn-print-slip" style="background:#d1fae5;border-color:#6ee7b7;color:#059669;" onclick="printAllStoringTags()">üè∑ PRINT ALL TAGS</button>
            <button class="btn-xls-commit" onclick="commitTransfer()">‚ö° COMMIT TO INVENTORY</button>
        </div>
    </div>

    <div class="xls-instructions">
        üí° <b>Grid:</b> Click cells to edit ¬∑ Paste from Excel (Ctrl+V) ¬∑ Click row# to select rows ¬∑ Tab/Enter/Arrows to navigate ¬∑ ‚öô to manage columns.
        &nbsp;|&nbsp; <b>File Upload:</b> üìÇ Upload Excel ‚Üí auto-detect columns + auto-assign locations ‚Üí review ‚Üí load to grid.
        &nbsp;|&nbsp; <b>Quick Paste:</b> üìã Paste tab-separated rows directly from the bulk import panel.
    </div>

    <div id="transfer-result" class="transfer-result" style="display:none;"></div>

    <!-- Column Manager Modal -->
    <div id="col-modal" class="modal-overlay" style="display:none;" onclick="if(event.target===this)closeColManager()">
        <div class="modal-box" style="max-width:420px;">
            <div class="modal-header">
                <span>‚öô MANAGE COLUMNS</span>
                <button class="modal-close" onclick="closeColManager()">‚úï</button>
            </div>
            <div style="padding:14px 16px;display:flex;flex-direction:column;gap:6px;overflow-y:auto;max-height:400px;" id="col-toggle-list"></div>
            <div style="padding:10px 16px;border-top:1px solid #e2e8f0;display:flex;gap:8px;justify-content:flex-end;">
                <button class="btn-xls-commit" style="padding:7px 16px;font-size:11px;" onclick="applyColChanges()">‚úì APPLY</button>
                <button class="btn-xls-action" onclick="closeColManager()">CANCEL</button>
            </div>
        </div>
    </div>

    <!-- EXCEL GRID -->
    <div class="xls-outer" id="xls-outer">
        <div class="xls-col-headers" id="xls-col-headers"><div class="xls-corner">ALL</div></div>
        <div class="xls-grid" id="xls-grid"></div>
    </div>

</div>
</main>

<div id="copy-toast" class="copy-toast">üìã Copied!</div>

<script src="script.js"></script>
<script>
['log-email','log-pass'].forEach(id=>{
    document.getElementById(id).addEventListener('keydown',e=>{if(e.key==='Enter')checkLogin();});
});
document.getElementById('slip-date').value = new Date().toISOString().split('T')[0];

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   COLUMN DEFINITIONS
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
const ALL_COLS = [
    { key:'loc',    label:'TLGP LOCATION',  w:'110px', type:'text',   upper:true,  ph:'TRA0101',    locked:true  },
    { key:'cod',    label:'ITEM CODE',      w:'1fr',   type:'text',   upper:true,  ph:'ITEM CODE',  locked:true  },
    { key:'srcloc', label:'SOURCE LOC.',    w:'95px',  type:'text',   upper:true,  ph:'RM-0-01',    locked:false },
    { key:'lot',    label:'LOT #',          w:'110px', type:'text',   upper:false, ph:'LOT NO.',    locked:false },
    { key:'sts',    label:'QUALITY STATUS', w:'115px', type:'select', opts:['PASSED','HOLD','UNDER QA','FAILED'], dflt:'PASSED', locked:false },
    { key:'qty',    label:'QUANTITY',       w:'90px',  type:'text',   upper:false, ph:'0',          locked:true  },
    { key:'noc',    label:'NO. OF CASES',   w:'85px',  type:'text',   upper:false, ph:'1',          locked:false },
    { key:'exp',    label:'EXPIRY DATE',    w:'105px', type:'text',   upper:false, ph:'YYYY-MM-DD', locked:false },
    { key:'pal',    label:'PALLET REF.',    w:'100px', type:'text',   upper:false, ph:'PAL-ID',     locked:false },
    { key:'rem',    label:'REMARKS',        w:'120px', type:'text',   upper:false, ph:'Remarks',    locked:false },
    { key:'dat',    label:'DATE',           w:'105px', type:'text',   upper:false, ph:'YYYY-MM-DD', locked:false },
    { key:'typ',    label:'ITEM TYPE',      w:'120px', type:'select', opts:['','RESIN','FILM','MOLDED PARTS','UN-STERILE','PACKAGING'], dflt:'', locked:false },
    { key:'dr',     label:'DR / INVOICE',   w:'120px', type:'text',   upper:false, ph:'DR / INV',   locked:false },
];

let visibleKeys = ['loc','cod','lot','sts','qty','noc','exp','pal','rem'];
try { const sv=JSON.parse(sessionStorage.getItem('tlgp_vis_cols')||'null'); if(Array.isArray(sv)&&sv.length) visibleKeys=sv; } catch(e){}

function getActiveCols(){ return ALL_COLS.filter(c=>visibleKeys.includes(c.key)); }
function getColIdx(key){ return getActiveCols().findIndex(c=>c.key===key); }

function showColManager(){
    document.getElementById('col-toggle-list').innerHTML = ALL_COLS.map(c=>`
        <label class="col-toggle-row">
            <input type="checkbox" value="${c.key}" ${visibleKeys.includes(c.key)?'checked':''} ${c.locked?'disabled':''}>
            <span style="flex:1;">${c.label}</span>
            ${c.locked?'<span style="font-size:9px;color:#94a3b8;">REQUIRED</span>':''}
        </label>`).join('');
    document.getElementById('col-modal').style.display='flex';
}
function closeColManager(){ document.getElementById('col-modal').style.display='none'; }
function applyColChanges(){
    const locked = ALL_COLS.filter(c=>c.locked).map(c=>c.key);
    const sel = new Set(locked);
    document.querySelectorAll('#col-toggle-list input:checked').forEach(cb=>sel.add(cb.value));
    const saved = ROWS.map(row=>{ const d={}; getActiveCols().forEach((c,ci)=>d[c.key]=getCellVal(row.ri,ci)); return d; });
    visibleKeys = ALL_COLS.filter(c=>sel.has(c.key)).map(c=>c.key);
    sessionStorage.setItem('tlgp_vis_cols', JSON.stringify(visibleKeys));
    closeColManager(); rebuildGrid(saved);
}
function applySlipType(){
    const typ=document.getElementById('slip-typ').value; if(!typ) return;
    const ci=getColIdx('typ'); if(ci<0) return;
    ROWS.forEach(row=>setCellVal(row.ri,ci,typ));
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   GRID ENGINE
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
let ROWS=[], rowSeq=0;
let sel={r1:-1,c1:-1,r2:-1,c2:-1};
let selectedRows=new Set();
let isDragging=false, dragAnchor=null;
const grid = document.getElementById('xls-grid');
const toast = document.getElementById('copy-toast');

function showToast(msg){ toast.textContent=msg; toast.classList.add('show'); clearTimeout(toast._t); toast._t=setTimeout(()=>toast.classList.remove('show'),1800); }

function setGridTemplate(){
    const cols = getActiveCols().map(d=>d.w).join(' ');
    grid.style.gridTemplateColumns = `36px ${cols}`;
    const hdr = document.getElementById('xls-col-headers');
    hdr.style.gridTemplateColumns = `36px ${cols}`;
    hdr.innerHTML = `<div class="xls-corner" onclick="selectAllRows()" title="Select all">ALL</div>`;
    getActiveCols().forEach((d,ci)=>{
        const el=document.createElement('div'); el.dataset.col=ci; el.textContent=d.label; el.title=d.label;
        el.addEventListener('click',()=>{ setSel(0,ci,ROWS.length-1,ci); if(ROWS[0]) focusCell(0,ci); });
        hdr.appendChild(el);
    });
}

function rebuildGrid(savedData){
    grid.innerHTML=''; ROWS=[]; rowSeq=0; sel={r1:-1,c1:-1,r2:-1,c2:-1}; selectedRows.clear();
    setGridTemplate();
    const newKeys=getActiveCols().map(c=>c.key);
    (savedData||[]).forEach(d=>createRow(newKeys.map(k=>d[k]||'')));
    if(!ROWS.length) addRows(20);
    updateBadge();
}

function createRow(data){
    rowSeq++;
    const ri=ROWS.length, activeCols=getActiveCols(), rd={id:`gr${rowSeq}`,ri};
    const rnum=document.createElement('div');
    rnum.className='xls-rnum'; rnum.textContent=rowSeq; rnum.dataset.ri=ri;
    rnum.addEventListener('click',e=>toggleRowSel(ri,e.shiftKey));
    activeCols.forEach((def,ci)=>{
        const wrap=document.createElement('div');
        wrap.className='xls-cell-wrap'; wrap.dataset.ri=ri; wrap.dataset.ci=ci;
        let el;
        if(def.type==='select'){
            el=document.createElement('select'); el.className='xls-sel';
            def.opts.forEach(o=>{ const op=document.createElement('option'); op.value=o; op.textContent=o||'‚Äî'; el.appendChild(op); });
            const iv=data?.[ci]||def.dflt||'';
            const m=def.opts.find(o=>o.toUpperCase()===(iv||'').toUpperCase());
            el.value=m!==undefined?m:(def.dflt||'');
        } else {
            el=document.createElement('div'); el.className='xls-inp';
            el.contentEditable='true'; el.spellcheck=false; el.dataset.ph=def.ph||'';
            el.textContent=data?.[ci]!=null?String(data[ci]):'';
            if(def.upper) el.addEventListener('input',()=>{ const p=scp(el); el.textContent=el.textContent.toUpperCase(); rcp(el,p); });
        }
        el.dataset.ri=ri; el.dataset.ci=ci;
        el.addEventListener('mousedown',onMD); el.addEventListener('focus',onFoc); el.addEventListener('keydown',onKD);
        wrap.appendChild(el); rd[`el_${ci}`]=el; rd[`wrap_${ci}`]=wrap;
    });
    rd.rnum=rnum; rd.cells=activeCols.map((_,ci)=>rd[`el_${ci}`]);
    ROWS.push(rd); grid.appendChild(rnum);
    activeCols.forEach((_,ci)=>grid.appendChild(rd[`wrap_${ci}`]));
    updateBadge(); return rd;
}

function addRows(n=10,dataArr=null){ for(let i=0;i<n;i++) createRow(dataArr?.[i]||null); }
function updateBadge(){
    const f=ROWS.filter(r=>getCellVal(r.ri,0)||getCellVal(r.ri,1)).length;
    document.getElementById('row-count-badge').textContent=`${f} / ${ROWS.length} rows`;
}

function toggleRowSel(ri,shiftKey){
    if(shiftKey&&selectedRows.size>0){ const last=Math.max(...selectedRows); const mn=Math.min(last,ri),mx=Math.max(last,ri); for(let i=mn;i<=mx;i++) selectedRows.add(i); }
    else { selectedRows.has(ri)?selectedRows.delete(ri):selectedRows.add(ri); }
    applyRSH();
}
function selectAllRows(){ ROWS.forEach(r=>selectedRows.add(r.ri)); applyRSH(); }
function clearRowSel(){ selectedRows.clear(); applyRSH(); }
function applyRSH(){
    ROWS.forEach(r=>{ const s=selectedRows.has(r.ri); r.rnum.classList.toggle('rnum-selected',s); getActiveCols().forEach((_,ci)=>{ const w=r[`wrap_${ci}`]; if(w) w.classList.toggle('row-selected',s); }); });
}
function deleteSelectedRows(){
    if(!selectedRows.size){ showToast('‚ö† Click row numbers to select rows'); return; }
    const del=[...selectedRows].sort((a,b)=>b-a);
    del.forEach(ri=>{ const r=ROWS[ri]; if(!r) return; r.rnum.remove(); getActiveCols().forEach((_,ci)=>{ const w=r[`wrap_${ci}`]; if(w) w.remove(); }); });
    ROWS=ROWS.filter(r=>!selectedRows.has(r.ri));
    ROWS.forEach((r,i)=>{ r.ri=i; r.rnum.textContent=i+1; r.rnum.dataset.ri=i; getActiveCols().forEach((_,ci)=>{ if(r[`el_${ci}`]) r[`el_${ci}`].dataset.ri=i; if(r[`wrap_${ci}`]) r[`wrap_${ci}`].dataset.ri=i; }); });
    rowSeq=ROWS.length; selectedRows.clear(); sel={r1:-1,c1:-1,r2:-1,c2:-1};
    if(!ROWS.length) addRows(5);
    updateBadge(); showToast(`üóë Deleted ${del.length} row(s)`);
}

function deleteEmptyRows(){
    const locI=getColIdx('loc'), codI=getColIdx('cod');
    const emptyRis=ROWS.filter(r=>{
        const l=locI>=0?getCellVal(r.ri,locI):'';
        const c=codI>=0?getCellVal(r.ri,codI):'';
        return !l.trim()&&!c.trim();
    }).map(r=>r.ri);
    if(!emptyRis.length){ showToast('‚úÖ No empty rows'); return; }
    emptyRis.sort((a,b)=>b-a).forEach(ri=>{
        const r=ROWS[ri]; if(!r) return;
        r.rnum.remove(); getActiveCols().forEach((_,ci)=>{ const w=r[`wrap_${ci}`]; if(w) w.remove(); });
    });
    ROWS=ROWS.filter(r=>!emptyRis.includes(r.ri));
    ROWS.forEach((r,i)=>{ r.ri=i; r.rnum.textContent=i+1; r.rnum.dataset.ri=i; getActiveCols().forEach((_,ci)=>{ if(r[`el_${ci}`]) r[`el_${ci}`].dataset.ri=i; if(r[`wrap_${ci}`]) r[`wrap_${ci}`].dataset.ri=i; }); });
    rowSeq=ROWS.length; sel={r1:-1,c1:-1,r2:-1,c2:-1};
    if(!ROWS.length) addRows(5);
    updateBadge(); showToast(`üóë Deleted ${emptyRis.length} empty row(s)`);
}

function normSel(s){ return{r1:Math.min(s.r1,s.r2),c1:Math.min(s.c1,s.c2),r2:Math.max(s.r1,s.r2),c2:Math.max(s.c1,s.c2)}; }
function setSel(r1,c1,r2,c2){ sel={r1,c1,r2,c2}; applySelH(); }
function applySelH(){
    document.querySelectorAll('.xls-cell-wrap.xls-sel').forEach(e=>e.classList.remove('xls-sel'));
    const n=normSel(sel); if(n.r1<0) return;
    for(let ri=n.r1;ri<=n.r2;ri++){ const r=ROWS[ri]; if(!r) continue; for(let ci=n.c1;ci<=n.c2;ci++){ const w=r[`wrap_${ci}`]; if(w) w.classList.add('xls-sel'); } }
}
function getCellVal(ri,ci){ const r=ROWS[ri]; if(!r) return''; const el=r[`el_${ci}`]; if(!el) return''; return el.tagName==='SELECT'?el.value:(el.textContent||'').trim(); }
function setCellVal(ri,ci,val){ const r=ROWS[ri]; if(!r) return; const el=r[`el_${ci}`]; if(!el) return; const def=getActiveCols()[ci]; if(el.tagName==='SELECT'){ const m=(def?.opts||[]).find(o=>o.toUpperCase()===(val||'').toUpperCase()); if(m!==undefined) el.value=m; } else { el.textContent=def?.upper?(val||'').toUpperCase():(val||''); } updateBadge(); }
function scp(el){ const s=window.getSelection(); if(!s.rangeCount) return 0; const r=s.getRangeAt(0),pre=r.cloneRange(); pre.selectNodeContents(el); pre.setEnd(r.endContainer,r.endOffset); return pre.toString().length; }
function rcp(el,pos){ const r=document.createRange(),s=window.getSelection(); let n=0,f=false; function t(node){ if(node.nodeType===3){ const e=n+node.length; if(!f&&pos<=e){ r.setStart(node,pos-n); r.collapse(true); f=true; } n=e; } else for(const c of node.childNodes) t(c); } t(el); if(!f){ r.selectNodeContents(el); r.collapse(false); } s.removeAllRanges(); s.addRange(r); }
function onMD(e){ const ri=parseInt(e.currentTarget.dataset.ri),ci=parseInt(e.currentTarget.dataset.ci); if(isNaN(ri)||isNaN(ci)) return; clearRowSel(); if(e.shiftKey&&sel.r1>=0){ sel.r2=ri; sel.c2=ci; applySelH(); e.preventDefault(); return; } isDragging=true; dragAnchor={ri,ci}; setSel(ri,ci,ri,ci); }
document.addEventListener('mousemove',e=>{ if(!isDragging) return; const el=document.elementFromPoint(e.clientX,e.clientY); if(!el) return; const w=el.closest('.xls-cell-wrap,[data-ri][data-ci]'); if(!w) return; const ri=parseInt(w.dataset.ri),ci=parseInt(w.dataset.ci); if(isNaN(ri)||isNaN(ci)) return; sel.r1=dragAnchor.ri; sel.c1=dragAnchor.ci; sel.r2=ri; sel.c2=ci; applySelH(); });
document.addEventListener('mouseup',()=>{ isDragging=false; });
function onFoc(e){ const ri=parseInt(e.currentTarget.dataset.ri),ci=parseInt(e.currentTarget.dataset.ci); if(!isNaN(ri)&&!isNaN(ci)) setSel(ri,ci,ri,ci); }
function onKD(e){
    const ri=parseInt(e.currentTarget.dataset.ri),ci=parseInt(e.currentTarget.dataset.ci),COLC=getActiveCols().length;
    if((e.ctrlKey||e.metaKey)&&e.key==='c'){ cpSel(); return; }
    if((e.ctrlKey||e.metaKey)&&e.key==='a'&&!e.currentTarget.closest('.xls-inp')){ e.preventDefault(); setSel(0,0,ROWS.length-1,COLC-1); return; }
    if((e.key==='Delete'||e.key==='Backspace')&&!e.currentTarget.closest('.xls-inp')){ clrSel(); return; }
    if(e.key==='Tab'){ e.preventDefault(); const nc=e.shiftKey?ci-1:ci+1; if(nc>=0&&nc<COLC) focusCell(ri,nc); else if(!e.shiftKey&&ri<ROWS.length-1) focusCell(ri+1,0); return; }
    if(e.key==='Enter'&&!e.shiftKey){ e.preventDefault(); if(ri<ROWS.length-1) focusCell(ri+1,ci); else{ addRows(5); setTimeout(()=>focusCell(ri+1,ci),10); } return; }
    const isEd=e.currentTarget.contentEditable==='true';
    if(e.key.startsWith('Arrow')&&!isEd){ e.preventDefault(); let nr=ri,nc=ci; if(e.key==='ArrowDown') nr=Math.min(ri+1,ROWS.length-1); if(e.key==='ArrowUp') nr=Math.max(ri-1,0); if(e.key==='ArrowRight') nc=Math.min(ci+1,COLC-1); if(e.key==='ArrowLeft') nc=Math.max(ci-1,0); if(e.shiftKey){ sel.r2=nr; sel.c2=nc; applySelH(); } else { focusCell(nr,nc); } }
}
function focusCell(ri,ci){ const r=ROWS[ri]; if(!r) return; const el=r[`el_${ci}`]; if(!el) return; el.focus(); setSel(ri,ci,ri,ci); if(el.contentEditable==='true'){ const r2=document.createRange(),s=window.getSelection(); r2.selectNodeContents(el); r2.collapse(false); s.removeAllRanges(); s.addRange(r2); } }
function cpSel(){ const n=normSel(sel); if(n.r1<0) return; let lines=[]; for(let ri=n.r1;ri<=n.r2;ri++){ let cols=[]; for(let ci=n.c1;ci<=n.c2;ci++) cols.push(getCellVal(ri,ci)); lines.push(cols.join('\t')); } const text=lines.join('\n'); navigator.clipboard.writeText(text).then(()=>showToast(`üìã Copied`)).catch(()=>{ const ta=document.createElement('textarea'); ta.value=text; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); document.body.removeChild(ta); showToast('üìã Copied'); }); }
function clrSel(){ const n=normSel(sel); for(let ri=n.r1;ri<=n.r2;ri++) for(let ci=n.c1;ci<=n.c2;ci++) setCellVal(ri,ci,''); }

document.addEventListener('paste',e=>{
    const a=document.activeElement;
    if(a&&(a.tagName==='INPUT'||a.tagName==='TEXTAREA')&&!a.classList.contains('xls-inp')) return;
    const clip=e.clipboardData||window.clipboardData, text=clip.getData('text'); if(!text) return;
    e.preventDefault();
    const lines=text.replace(/\r\n/g,'\n').replace(/\r/g,'\n').trim().split('\n').map(l=>l.split('\t').map(c=>c.trim()));
    const n=normSel(sel), sR=n.r1>=0?n.r1:0, sC=n.c1>=0?n.c1:0;
    lines.forEach((cols,ri)=>{ const tRi=sR+ri; while(ROWS.length<=tRi) addRows(5); cols.forEach((val,ci)=>{ const tCi=sC+ci; if(tCi<getActiveCols().length) setCellVal(tRi,tCi,val); }); });
    setSel(sR,sC,sR+lines.length-1,Math.min(sC+(lines[0]?.length||1)-1,getActiveCols().length-1));
    showToast(`üìã Pasted ${lines.length} row${lines.length>1?'s':''}`);
});
document.addEventListener('keydown',e=>{ if((e.ctrlKey||e.metaKey)&&e.key==='c'&&sel.r1>=0){ const a=document.activeElement; if(a&&a.closest('#xls-grid')) cpSel(); } });
document.addEventListener('mousedown',e=>{ if(!e.target.closest('#xls-outer')&&!e.target.closest('#xls-col-headers')){ sel={r1:-1,c1:-1,r2:-1,c2:-1}; applySelH(); } });

function saveGridState(){
    try{
        const ac=getActiveCols();
        const rows=ROWS.map(row=>{ const d={}; ac.forEach((c,ci)=>d[c.key]=getCellVal(row.ri,ci)); return d; });
        sessionStorage.setItem('tlgp_grid_draft',JSON.stringify({ rows, visCols:visibleKeys, slipDate:document.getElementById('slip-date').value, slipTsno:document.getElementById('slip-tsno').value, slipDr:document.getElementById('slip-dr').value, slipTyp:document.getElementById('slip-typ').value, slipSts:document.getElementById('slip-sts').value }));
        showToast('üíæ Draft saved');
    }catch(e){ showToast('‚ö† Could not save draft'); }
}
function loadGridState(){
    try{
        const raw=sessionStorage.getItem('tlgp_grid_draft'); if(!raw) return null;
        const d=JSON.parse(raw);
        if(Array.isArray(d.visCols)&&d.visCols.length) visibleKeys=d.visCols;
        const fm={slipDate:'slip-date',slipTsno:'slip-tsno',slipDr:'slip-dr',slipTyp:'slip-typ',slipSts:'slip-sts'};
        Object.entries(fm).forEach(([k,id])=>{ const el=document.getElementById(id); if(el&&d[k]) el.value=d[k]; });
        return Array.isArray(d.rows)&&d.rows.length?d.rows:null;
    }catch(e){ return null; }
}
function clearGrid(){
    if(!confirm('Clear all rows?')) return;
    grid.innerHTML=''; ROWS=[]; rowSeq=0; sel={r1:-1,c1:-1,r2:-1,c2:-1}; selectedRows.clear();
    setGridTemplate(); addRows(20); updateBadge(); sessionStorage.removeItem('tlgp_grid_draft');
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   COMMIT TRANSFER GRID ‚Üí FIREBASE INVENTORY
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function commitTransfer(){
    const slipTsno = document.getElementById('slip-tsno').value.trim();
    const slipDat  = document.getElementById('slip-date').value;
    const slipTyp  = document.getElementById('slip-typ').value;
    const slipSts  = document.getElementById('slip-sts').value;
    const drFinal  = slipTsno || '';

    const importRows = [];
    ROWS.forEach(row=>{
        const locI = getColIdx('loc'), codI = getColIdx('cod');
        const loc = locI>=0 ? getCellVal(row.ri, locI) : '';
        const cod = codI>=0 ? getCellVal(row.ri, codI) : '';
        if(!loc || !cod) return;
        const g = key=>{ const i=getColIdx(key); return i>=0?getCellVal(row.ri,i):''; };
        importRows.push([
            loc, cod,
            g('lot'),
            g('sts') || slipSts || 'PASSED',
            g('qty') || '0',
            g('pal'),
            drFinal,          // DR/Invoice = TS Control No. always
            g('dat') || slipDat,
            g('typ') || slipTyp,
        ]);
    });

    if(!importRows.length){ alert('‚ùå No valid rows. Fill at least TLGP LOCATION and ITEM CODE.'); return; }

    const added = processGridImport(importRows);
    if(added > 0){
        document.getElementById('transfer-result').style.display='flex';
        document.getElementById('transfer-result').innerHTML=`‚úÖ Transferred <b>${added}</b> item${added!==1?'s':''} to inventory successfully! <a href="index.html" class="res-link">View Inventory ‚Üí</a>`;
        sessionStorage.removeItem('tlgp_grid_draft');
        grid.innerHTML=''; ROWS=[]; rowSeq=0; sel={r1:-1,c1:-1,r2:-1,c2:-1}; selectedRows.clear();
        setGridTemplate(); addRows(20); updateBadge();
    }
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   EXCEL UPLOAD + REVIEW LOGIC
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
let _xlsxFile = null;
let _reviewRows = []; // array of row objects ready for review

// Location pool ‚Äî built lazily from masterLocs
function buildLocPool(){
    const pad = n => n.toString().padStart(2,'0');
    const locs = [];
    ['TRA','TRB','TRC','TRD','TRE','TRF','TRG','TRH','TRI','TRJ','TRK','TRL','TRM','TRN','TRO','TRP','TRQ'].forEach(z=>{
        for(let i=1;i<=70;i++) for(let l=1;l<=5;l++) locs.push(`${z}${pad(i)}${pad(l)}`);
    });
    return locs;
}

// Get occupied locations from Firebase db
function getOccupiedLocs(){
    const occ = new Set();
    (typeof db !== 'undefined' ? db : []).forEach(x=>{
        if(x && x.loc && parseFloat((x.qty||'0').toString().replace(/,/g,''))>0) occ.add(x.loc);
    });
    return occ;
}

// Find next available location not in usedSet
function nextVacantLoc(pool, usedSet){
    for(const loc of pool){
        if(!usedSet.has(loc)) return loc;
    }
    return null;
}

function handleFileSelect(event){
    const file = event.target.files[0];
    if(!file) return;
    setUploadFile(file);
}
function handleDrop(event){
    event.preventDefault();
    document.getElementById('upload-dropzone').classList.remove('drag-over');
    const file = event.dataTransfer.files[0];
    if(!file) return;
    if(!file.name.match(/\.(xlsx|xls|csv)$/i)){
        showUploadResult('err','‚ùå Please upload an .xlsx, .xls, or .csv file.');
        return;
    }
    setUploadFile(file);
}
function setUploadFile(file){
    _xlsxFile = file;
    const nameEl = document.getElementById('upload-file-name');
    nameEl.textContent = 'üìÑ ' + file.name;
    nameEl.style.display = 'block';
    document.getElementById('btn-parse-excel').disabled = false;
    document.getElementById('upload-result').style.display = 'none';
}
function showUploadResult(type, msg){
    const el = document.getElementById('upload-result');
    el.className = `upload-result ${type}`;
    el.textContent = msg;
    el.style.display = 'block';
}

// Column header aliases ‚Üí canonical key
/*
 * KEYWORD RULES ‚Äî each rule has a canonical key and an array of keywords.
 * A header matches if it contains ANY of the keywords (after stripping
 * all non-alphanumeric chars and lowercasing).
 * Rules are checked in order; more specific rules are listed first.
 * Priority decides which rule wins when multiple match (lower = higher priority).
 */
/*
 * ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
 *  COLUMN MATCHING ENGINE
 *  
 *  Rules (ordered by priority, lower = higher priority):
 *   - EXACT:     stripped header === keyword            ‚Üí always wins
 *   - CONTAINS:  stripped header contains keyword       ‚Üí s.includes(kw), kw.length >= 4
 *   - CONTAINED: keyword contains stripped header       ‚Üí kw.includes(s), s.length >= 4
 *                (min length 4 prevents "no" ‚Üí noc, "lot" ‚Üí "palletno", etc.)
 *
 *  Multi-word headers like "PRODUCT/ITEM CODE" are stripped to
 *  "productitemcode" which contains "itemcode" ‚Üí maps to 'cod'. ‚úÖ
 * ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
 */
const COL_RULES = [
    // SPECIFIC matches first (higher priority = lower p number)
    { k:'srcloc', p:1,  kw:['sourceloc','srcloc','sourcelocation','sourceloc','srcl'] },
    { k:'loc',    p:2,  kw:['tlgploc','tlgplocation','warehouseloc','warehouselocation'] },
    { k:'noc',    p:3,  kw:['noofcases','numberofcases','numcases','nocases','numberofcase'] },
    { k:'cod',    p:4,  kw:['productitemcode','itemcode','productcode','productitem','itemno','partno','partcode','materialcode','matcode','matno'] },
    { k:'lot',    p:5,  kw:['lotno','lotnumber','batchno','batchnumber'] },
    { k:'sts',    p:6,  kw:['qualitystatus','qualitysts','qcstatus'] },
    { k:'qty',    p:7,  kw:['quantity'] },
    { k:'exp',    p:8,  kw:['expirydate','expirationdate','expdate','bestbefore'] },
    { k:'pal',    p:9,  kw:['palletref','palletreference','palletid','palletno'] },
    { k:'rem',    p:10, kw:['remarks','remark'] },
    { k:'dat',    p:11, kw:['storingdate','transferdate','receivingdate'] },
    { k:'typ',    p:12, kw:['itemtype','materialtype'] },
    { k:'dr',     p:13, kw:['drinvoice','deliveryreceipt','invoiceno','drno'] },
    // BROAD fallbacks ‚Äî require longer match to avoid false positives
    { k:'loc',    p:20, kw:['location'] },
    { k:'lot',    p:21, kw:['lotnum','batch','lot'] },
    { k:'sts',    p:22, kw:['status'] },
    { k:'qty',    p:23, kw:['qty'] },
    { k:'exp',    p:24, kw:['expiry','expiration'] },
    { k:'pal',    p:25, kw:['pallet'] },
    { k:'dat',    p:26, kw:['date'] },
    { k:'typ',    p:27, kw:['type'] },
    { k:'dr',     p:28, kw:['invoice'] },
    { k:'noc',    p:29, kw:['cases','noc'] },
    { k:'cod',    p:30, kw:['product','item','code'] },  // very broad, last resort
    { k:'loc',    p:31, kw:['loc'] },
];

// Strip everything except alphanumeric, lowercase
function stripH(h){ return (h||'').toString().toLowerCase().replace(/[^a-z0-9]/g,''); }

function matchColKey(rawHeader){
    const s = stripH(rawHeader);
    if(!s || s.length < 2) return null;
    let best = null;
    for(const rule of COL_RULES){
        for(const kw of rule.kw){
            const hit = (s === kw)                          // exact
                     || (kw.length >= 4 && s.includes(kw)) // header contains keyword (kw must be ‚â•4 chars)
                     || (s.length >= 4 && kw.includes(s)); // keyword contains header (s must be ‚â•4 chars)
            if(hit){
                if(!best || rule.p < best.p){ best = rule; }
                break;
            }
        }
    }
    return best ? best.k : null;
}

/*
 * ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
 *  PARSE EXCEL  
 *
 *  Handles Transfer Slip format:
 *   - Company/title block rows before actual column headers
 *   - "PRODUCT/ITEM CODE" spanning or appearing as multi-line header
 *   - Merged cells (SheetJS only reads value from top-left cell)
 *   - Excel date serials
 *
 *  Strategy:
 *   1. Scan rows 0‚Äì19, score each row by how many cells match known columns
 *   2. Also try COMBINING two adjacent rows (for split 2-row headers)
 *   3. Pick the candidate with the highest score (no early break)
 *   4. Build colMap, parse data rows
 * ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
 */
function parseExcelData(workbook){
    const sheet = workbook.Sheets[workbook.SheetNames[0]];
    const raw   = XLSX.utils.sheet_to_json(sheet, { header:1, defval:'' });
    if(!raw || raw.length < 2) return { error:'Sheet appears empty or has no data rows.' };

    // Score a row (array of cell values)
    function scoreRow(row){
        const seen = new Set();
        let score = 0;
        for(const c of row){
            const k = matchColKey(c);
            if(k && !seen.has(k)){ seen.add(k); score++; }
        }
        return score;
    }

    // Build a merged header by joining two adjacent rows cell-by-cell
    // (handles "PRODUCT/ITEM" on row N and "CODE" on row N+1)
    function mergeRows(rowA, rowB){
        const len = Math.max(rowA.length, rowB.length);
        const merged = [];
        for(let i = 0; i < len; i++){
            const a = (rowA[i]||'').toString().trim();
            const b = (rowB[i]||'').toString().trim();
            merged.push(a && b ? `${a} ${b}` : a || b);
        }
        return merged;
    }

    const SCAN = Math.min(20, raw.length);
    let bestScore = 0;
    let bestHeaders = raw[0];
    let bestHeaderRowIdx = 0;

    for(let i = 0; i < SCAN; i++){
        // Single-row candidate
        const s1 = scoreRow(raw[i]);
        if(s1 > bestScore){ bestScore = s1; bestHeaders = raw[i]; bestHeaderRowIdx = i; }

        // Two-row merged candidate (combines row i and row i+1)
        if(i + 1 < SCAN){
            const merged = mergeRows(raw[i], raw[i+1]);
            const sm = scoreRow(merged);
            if(sm > bestScore){ bestScore = sm; bestHeaders = merged; bestHeaderRowIdx = i; }
        }
    }

    // Build colMap ‚Äî first match per canonical key wins
    const colMap   = {};
    const usedKeys = new Set();
    bestHeaders.forEach((h, i) => {
        const key = matchColKey(h);
        if(key && !usedKeys.has(key)){ colMap[i] = key; usedKeys.add(key); }
    });

    // Debug ‚Äî open browser console (F12) to see what was detected
    console.log('[TLGP Import] Best header row index:', bestHeaderRowIdx, '| Score:', bestScore);
    console.log('[TLGP Import] Headers used:', bestHeaders);
    console.log('[TLGP Import] Column map:', colMap);

    // ‚îÄ‚îÄ Scan ALL rows before the header row for TS Control No. ‚îÄ‚îÄ
    let detectedTsno = '';
    const tsnoLabelRe = /ts[\s.]*control[\s.]*no\.?/i;
    outerTsno:
    for(let r = 0; r <= Math.min(bestHeaderRowIdx + 2, raw.length - 1); r++){
        const rowArr = raw[r];
        for(let c2 = 0; c2 < rowArr.length; c2++){
            const cell = (rowArr[c2]||'').toString().trim();
            if(!cell) continue;
            if(tsnoLabelRe.test(cell)){
                const afterColon = cell.replace(tsnoLabelRe,'').replace(/^[\s:.\-]+/,'').trim();
                if(afterColon){ detectedTsno = afterColon; break outerTsno; }
                for(let nc = c2+1; nc < Math.min(c2+5, rowArr.length); nc++){
                    const nval = (rowArr[nc]||'').toString().trim();
                    if(nval){ detectedTsno = nval; break outerTsno; }
                }
            }
        }
    }
    console.log('[TLGP Import] Detected TS Control No.:', detectedTsno || '(none)');

    const validSts = ['PASSED','HOLD','UNDER QA','FAILED'];
    const dataStartRow = bestHeaderRowIdx + 1;
    const rows = [];

    for(let r = dataStartRow; r < raw.length; r++){
        const rowArr = raw[r];
        if(rowArr.every(c => !(c||'').toString().trim())) continue; // skip blank rows
        const obj = { loc:'', cod:'', lot:'', sts:'', qty:'', noc:'', exp:'', pal:'', rem:'', dat:'', typ:'', dr:'', srcloc:'' };

        Object.entries(colMap).forEach(([ci, key]) => {
            let val = (rowArr[parseInt(ci)]||'').toString().trim();
            // Convert Excel date serial numbers ‚Üí YYYY-MM-DD
            if(key === 'dat' || key === 'exp'){
                const num = parseFloat(val);
                if(!isNaN(num) && num > 40000 && num < 60000){
                    try {
                        const d = XLSX.SSF.parse_date_code(num);
                        val = `${d.y}-${String(d.m).padStart(2,'0')}-${String(d.d).padStart(2,'0')}`;
                    } catch(e){}
                }
            }
            // Normalize quality status
            if(key === 'sts'){
                const up = val.toUpperCase();
                val = validSts.find(s => s === up) || val || '';
            }
            obj[key] = val;
        });

        // STOP if this row is a TOTAL / GRAND TOTAL / SUBTOTAL summary row
        const rowText = rowArr.map(c=>(c||'').toString().toUpperCase().trim()).join(' ');
        const isTotalRow = /\bTOTAL\b|\bGRAND TOTAL\b|\bSUBTOTAL\b/.test(rowText);
        if(isTotalRow) break;

        // SKIP rows that look like column header rows (repeating headers in merged-cell Excel files)
        const isHeaderRow = rowArr.some(c => {
            const t = (c||'').toString().toUpperCase().trim();
            return t === 'NO.' || t === 'NO'
                || t === 'ITEM CODE' || t === 'PRODUCT CODE'
                || t === 'PRODUCT/ITEM CODE' || t === 'PRODUCT/ ITEM CODE'
                || t === 'LOT #' || t === 'LOT NUMBER' || t === 'LOT NO' || t === 'LOT NO.'
                || t === 'LOCATION' || t === 'QUANTITY' || t === 'QTY'
                || t === 'QUALITY STATUS' || t === 'STATUS'
                || t === 'NO. OF CASES' || t === 'NO OF CASES' || t === 'CASES'
                || t === 'EXPIRY DATE' || t === 'EXPIRY' || t === 'PALLET NO.' || t === 'PALLET NO'
                || t === 'REMARKS' || t === 'DR / INVOICE' || t === 'DR/INVOICE';
        });
        if(isHeaderRow) continue;

        // Skip rows where item code is empty (e.g., footer/total rows)
        if(!obj.cod) continue;
        rows.push(obj);
    }

    if(rows.length === 0){
        // Extra debug: show what headers were detected
        const detected = Object.entries(colMap).map(([ci,k])=>`col${ci}‚Üí${k}`).join(', ');
        console.warn('[TLGP Import] No data rows found. ColMap:', detected, '| Header row:', bestHeaderRowIdx);
        return {
            error: `No valid data rows found.\n\nDetected ${Object.keys(colMap).length} column(s): ${detected || 'none'}\nHeader row index: ${bestHeaderRowIdx}\n\nMake sure your Excel has a column named "PRODUCT/ITEM CODE" or similar, with data rows below it.`,
            colMap, bestHeaders, bestHeaderRowIdx
        };
    }

    return { rows, colMap, headerRowIdx: bestHeaderRowIdx, headers: bestHeaders, tsno: detectedTsno };
}

function parseAndReview(){
    if(!_xlsxFile){ showUploadResult('err','‚ö† Please select a file first.'); return; }
    const btn = document.getElementById('btn-parse-excel');
    btn.disabled = true;
    btn.innerHTML = '‚è≥ PARSING...';

    const reader = new FileReader();
    reader.onload = function(e){
        try {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, { type:'array' });
            const result = parseExcelData(workbook);
            if(result.error){
                showUploadResult('err', '‚ùå ' + result.error);
                btn.disabled = false;
                btn.innerHTML = 'üîç PREVIEW &amp; ASSIGN LOCATIONS';
                return;
            }
            if(!result.rows || result.rows.length===0){
                showUploadResult('err', '‚ùå No valid data rows found. Make sure your Excel has an Item Code column.');
                btn.disabled = false;
                btn.innerHTML = 'üîç PREVIEW &amp; ASSIGN LOCATIONS';
                return;
            }
            showUploadResult('ok', `‚úÖ ${result.rows.length} rows parsed${result.tsno ? ' ¬∑ TS Control No: ' + result.tsno : ''}. Opening review screen...`);
            if(result.tsno){ document.getElementById('slip-tsno').value = result.tsno; }
            openReviewModal(result.rows, _xlsxFile.name);
        } catch(err){
            showUploadResult('err', '‚ùå Failed to parse file: ' + err.message);
        }
        btn.disabled = false;
        btn.innerHTML = 'üîç PREVIEW &amp; ASSIGN LOCATIONS';
    };
    reader.readAsArrayBuffer(_xlsxFile);
}

function openReviewModal(parsedRows, filename){
    const locPool  = buildLocPool();
    const occupied = getOccupiedLocs();
    const usedInSession = new Set([...occupied]); // tracks locs assigned in this session

    const validSts = ['PASSED','HOLD','UNDER QA','FAILED'];

    _reviewRows = parsedRows.map((r, i) => {
        let loc = (r.loc||'').toUpperCase().trim();
        let autoAssigned = false;
        let conflict = false;

        if(!loc){
            // Auto-assign next vacant
            const next = nextVacantLoc(locPool, usedInSession);
            if(next){ loc = next; autoAssigned = true; usedInSession.add(next); }
        } else {
            if(usedInSession.has(loc)){ conflict = true; }
            else { usedInSession.add(loc); }
        }

        const stsRaw = (r.sts||'').toUpperCase();
        const sts = validSts.find(s=>s===stsRaw) || 'PASSED';

        return {
            idx: i,
            loc, cod: (r.cod||'').toUpperCase(), lot: r.lot||'',
            sts, qty: r.qty||'', noc: r.noc||'', exp: r.exp||'',
            pal: r.pal||'', rem: r.rem||'', dat: r.dat||'',
            typ: r.typ||'', dr: r.dr||'', srcloc: (r.srcloc||'').toUpperCase(),
            autoAssigned, conflict
        };
    });

    // Populate modal
    document.getElementById('review-filename-label').textContent = 'File: ' + filename;
    document.getElementById('rv-stat-rows').textContent = _reviewRows.length;
    document.getElementById('rv-stat-auto').textContent = _reviewRows.filter(r=>r.autoAssigned).length;
    document.getElementById('rv-stat-conflict').textContent = _reviewRows.filter(r=>r.conflict).length;
    const totalQty = _reviewRows.reduce((s,r)=>{ const n=parseFloat((r.qty||'0').toString().replace(/,/g,'')); return s+(isNaN(n)?0:n); },0);
    document.getElementById('rv-stat-qty').textContent = totalQty.toLocaleString();
    document.getElementById('rv-load-count').textContent = _reviewRows.length + ' rows';

    renderReviewTable();
    document.getElementById('review-modal').classList.add('open');
}

function renderReviewTable(){
    const tbody = document.getElementById('review-tbody');
    tbody.innerHTML = _reviewRows.map((r, i) => {
        const statusCls = {
            'PASSED':'chip-passed','HOLD':'chip-hold',
            'UNDER QA':'chip-underqa','FAILED':'chip-failed'
        }[r.sts]||'chip-default';
        const rowCls = r.conflict ? 'row-conflict' : (r.autoAssigned ? 'row-ok' : '');
        const locCls = r.conflict ? 'conflict' : (r.loc ? 'vacant' : '');
        const badge = r.conflict
            ? `<span class="conflict-badge">‚ö† CONFLICT</span>`
            : (r.autoAssigned
                ? `<span class="ok-badge">‚úì AUTO</span>`
                : `<span class="ok-badge">‚úì SET</span>`);
        return `<tr class="${rowCls}" data-review-idx="${i}">
            <td class="row-num-cell">${i+1}</td>
            <td>
                <input class="review-loc-input ${locCls}"
                    data-ri="${i}"
                    value="${r.loc}"
                    maxlength="7"
                    oninput="updateReviewLoc(${i},this.value)"
                    placeholder="TRA0101">
            </td>
            <td style="font-weight:700;color:#1e293b;font-family:'JetBrains Mono',monospace;">${r.cod}</td>
            <td style="font-family:'JetBrains Mono',monospace;">${r.lot||'‚Äî'}</td>
            <td><span class="status-chip ${statusCls}">${r.sts}</span></td>
            <td style="color:#2563eb;font-weight:700;font-family:'JetBrains Mono',monospace;">${r.qty||'‚Äî'}</td>
            <td>${r.noc||'‚Äî'}</td>
            <td>${r.exp||'‚Äî'}</td>
            <td>${r.pal||'‚Äî'}</td>
            <td style="color:#6b7280;">${r.rem||'‚Äî'}</td>
            <td>${r.dat||'‚Äî'}</td>
            <td>${r.typ||'‚Äî'}</td>
            <td style="font-family:'JetBrains Mono',monospace;">${r.dr||'‚Äî'}</td>
            <td style="color:#64748b;">${r.srcloc||'‚Äî'}</td>
            <td>${badge}</td>
        </tr>`;
    }).join('');
}

function updateReviewLoc(idx, val){
    const loc = val.toUpperCase().trim();
    const input = document.querySelector(`.review-loc-input[data-ri="${idx}"]`);
    _reviewRows[idx].loc = loc;

    // Check conflict
    const occupied = getOccupiedLocs();
    const otherLocs = new Set(_reviewRows.filter((_,i)=>i!==idx).map(r=>r.loc).filter(Boolean));
    const allUsed = new Set([...occupied, ...otherLocs]);
    const conflict = loc && allUsed.has(loc);
    _reviewRows[idx].conflict = conflict;
    _reviewRows[idx].autoAssigned = false;

    if(input){
        input.className = `review-loc-input ${conflict?'conflict':(loc?'vacant':'')}`;
    }

    // Update conflict stat
    document.getElementById('rv-stat-conflict').textContent = _reviewRows.filter(r=>r.conflict).length;
}

function reassignAllConflicts(){
    const locPool  = buildLocPool();
    const occupied = getOccupiedLocs();
    const usedInSession = new Set([...occupied, ..._reviewRows.filter(r=>!r.conflict).map(r=>r.loc).filter(Boolean)]);

    _reviewRows.forEach((r, i)=>{
        if(r.conflict){
            const next = nextVacantLoc(locPool, usedInSession);
            if(next){ r.loc = next; r.conflict = false; r.autoAssigned = true; usedInSession.add(next); }
        }
    });

    document.getElementById('rv-stat-auto').textContent = _reviewRows.filter(r=>r.autoAssigned).length;
    document.getElementById('rv-stat-conflict').textContent = _reviewRows.filter(r=>r.conflict).length;
    renderReviewTable();
    showToast('‚ôªÔ∏è Conflicts reassigned');
}

function closeReviewModal(){
    document.getElementById('review-modal').classList.remove('open');
}

function loadReviewToGrid(){
    const conflicts = _reviewRows.filter(r=>r.conflict);
    if(conflicts.length > 0){
        if(!confirm(`‚ö†Ô∏è There are ${conflicts.length} location conflict(s). These will overwrite existing stock if committed.\n\nContinue loading to grid?`)) return;
    }

    closeReviewModal();

    // Delete empty rows first
    const emptyRis = ROWS.filter(r=>!getCellVal(r.ri,0)&&!getCellVal(r.ri,1)).map(r=>r.ri);
    emptyRis.sort((a,b)=>b-a).forEach(ri=>{
        const r=ROWS[ri]; if(!r) return;
        r.rnum.remove(); getActiveCols().forEach((_,ci)=>{ const w=r[`wrap_${ci}`]; if(w) w.remove(); });
    });
    ROWS = ROWS.filter(r=>!emptyRis.includes(r.ri));
    ROWS.forEach((r,i)=>{ r.ri=i; r.rnum.textContent=i+1; r.rnum.dataset.ri=i; getActiveCols().forEach((_,ci)=>{ if(r[`el_${ci}`]) r[`el_${ci}`].dataset.ri=i; if(r[`wrap_${ci}`]) r[`wrap_${ci}`].dataset.ri=i; }); });
    rowSeq = ROWS.length;

    // Get slip defaults
    const slipDr  = document.getElementById('slip-dr').value.trim();
    const slipDat = document.getElementById('slip-date').value;
    const slipTyp = document.getElementById('slip-typ').value;
    const slipSts = document.getElementById('slip-sts').value;

    // Build data arrays for createRow
    const ac = getActiveCols();
    _reviewRows.forEach(r => {
        // Fill in defaults from slip header if field is empty
        const rowData = ac.map(col => {
            switch(col.key){
                case 'loc':    return r.loc;
                case 'cod':    return r.cod;
                case 'lot':    return r.lot;
                case 'sts':    return r.sts || slipSts || 'PASSED';
                case 'qty':    return r.qty;
                case 'noc':    return r.noc;
                case 'exp':    return r.exp;
                case 'pal':    return r.pal;
                case 'rem':    return r.rem;
                case 'dat':    return r.dat || slipDat;
                case 'typ':    return r.typ || slipTyp;
                case 'dr':     return r.dr || slipDr;
                case 'srcloc': return r.srcloc;
                default:       return '';
            }
        });
        createRow(rowData);
    });

    updateBadge();
    showToast(`‚úÖ ${_reviewRows.length} rows loaded to grid`);

    // Reset upload panel
    _xlsxFile = null;
    document.getElementById('upload-file-name').style.display = 'none';
    document.getElementById('btn-parse-excel').disabled = true;
    document.getElementById('upload-result').style.display = 'none';
    document.getElementById('excel-file-input').value = '';
    _reviewRows = [];
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   SIDEBAR BULK IMPORT (PASTE)
   Format: Loc ¬∑ Code ¬∑ Lot ¬∑ Status ¬∑ Qty ¬∑ Pallet ¬∑ DR ¬∑ Date ¬∑ Type
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function impBulk(){
    const raw = document.getElementById('xl').value.trim();
    const res = document.getElementById('bulk-result');
    res.style.display='none';
    if(!raw){ res.className='bulk-result err'; res.textContent='‚ö† Please paste data first.'; res.style.display='block'; return; }
    const validSts = ['PASSED','HOLD','UNDER QA','FAILED'];
    const lines = raw.replace(/\r\n/g,'\n').replace(/\r/g,'\n').split('\n').filter(l=>l.trim());
    const importRows = []; let skipped=0;
    lines.forEach((line,i)=>{
        const c = line.split('\t').map(s=>(s||'').trim());
        const loc = c[0].toUpperCase();
        const cod = c[1].toUpperCase();
        if(i===0 && (!loc || ['LOCATION','LOC','TLGP LOCATION','TLGP LOC'].includes(loc))){ skipped++; return; }
        if(!loc || !cod){ skipped++; return; }
        const stsRaw = (c[3]||'').toUpperCase();
        const sts = validSts.find(s=>s.toUpperCase()===stsRaw) || 'PASSED';
        importRows.push([loc, cod, c[2]||'', sts, c[4]||'0', c[5]||'', c[6]||'', c[7]||'', c[8]||'']);
    });
    if(!importRows.length){
        res.className='bulk-result err';
        res.textContent='‚ùå No valid rows found. Expected: Loc[TAB]Code[TAB]Lot[TAB]Status[TAB]Qty[TAB]Pallet[TAB]DR[TAB]Date[TAB]Type';
        res.style.display='block'; return;
    }
    const added = processGridImport(importRows);
    document.getElementById('xl').value='';
    res.className='bulk-result ok';
    res.textContent=`‚úÖ ${added} item${added!==1?'s':''} imported to inventory!${skipped?` (${skipped} skipped)`:''}`; 
    res.style.display='block';
    setTimeout(()=>res.style.display='none', 6000);
}

/* ‚îÄ‚îÄ Print Slip ‚Äî opens new window for proper landscape ‚îÄ‚îÄ */
function printSlip(){
    const rows=ROWS.map(row=>{ const d={}; getActiveCols().forEach((c,ci)=>d[c.key]=getCellVal(row.ri,ci)); return d; }).filter(r=>r.loc&&r.cod);
    if(!rows.length){ alert('‚ùå No data to print.'); return; }
    const tsno     = document.getElementById('slip-tsno').value||'‚Äî';
    const slipDate = document.getElementById('slip-date').value||'';
    const slipSts  = document.getElementById('slip-sts').value;
    let totalQty=0, totalCases=0;
    rows.forEach(r=>{ totalQty+=parseFloat(r.qty)||0; totalCases+=parseFloat(r.noc)||0; });

    const tbody = rows.map((r,i)=>`
        <tr>
            <td>${i+1}</td>
            <td class="l"><b>${r.cod||'‚Äî'}</b></td>
            <td>${r.srcloc||'‚Äî'}</td>
            <td>${r.lot||'‚Äî'}</td>
            <td>${r.sts||slipSts||'‚Äî'}</td>
            <td class="r">${(parseFloat(r.qty)||0).toLocaleString()}</td>
            <td>${r.noc||''}</td>
            <td>${r.exp||''}</td>
            <td>${r.pal||''}</td>
            <td class="l">${r.rem||''}</td>
            <td><b>${r.loc}</b></td>
        </tr>`).join('');

    const html = `<!DOCTYPE html><html><head><meta charset="utf-8">
<title>Transfer Slip</title>
<style>
  @page { size: A4 landscape; margin: 8mm 10mm; }
  * { box-sizing:border-box; -webkit-print-color-adjust:exact !important; print-color-adjust:exact !important; margin:0; padding:0; }
  body { font-family:Arial,Helvetica,sans-serif; font-size:8pt; color:#000; background:#fff; }

  .page { width:277mm; margin:0 auto; }

  /* HEADER */
  .hdr { display:flex; align-items:flex-end; justify-content:space-between; margin-bottom:2mm; }
  .hdr-left { min-width:65mm; }
  .logo-row { margin-bottom:1.5mm; }
  .ft-row  { display:flex; align-items:baseline; gap:2mm; margin-top:1mm; font-size:7.5pt; font-weight:600; }
  .ft-lbl  { font-weight:700; min-width:10mm; }
  .ft-val  { border-bottom:1px solid #000; min-width:30mm; padding-bottom:0.5mm; }
  .hdr-center { flex:1; text-align:center; padding:0 4mm; }
  .slip-title { font-size:22pt; font-weight:900; letter-spacing:2px; line-height:1; }
  .hdr-right  { min-width:65mm; display:flex; flex-direction:column; align-items:flex-end; gap:2mm; justify-content:flex-end; }
  .ctrl-row   { display:flex; align-items:baseline; gap:2mm; }
  .ctrl-lbl   { font-size:7.5pt; font-weight:700; white-space:nowrap; }
  .ctrl-val   { font-size:9pt; font-weight:900; font-family:'Courier New',monospace; border-bottom:1.5px solid #000; min-width:45mm; padding-bottom:0.5mm; }

  /* BORDERED BOX */
  .box { border:1.5px solid #000; width:100%; }
  .date-row { display:flex; align-items:center; gap:3mm; padding:1.5mm 3mm; border-bottom:1px solid #999; font-size:7.5pt; font-weight:700; }
  .date-val { border-bottom:1px solid #000; min-width:35mm; display:inline-block; }

  /* TABLE */
  table { width:100%; border-collapse:collapse; table-layout:fixed; }
  thead th { background:#c8c8c8; border:1px solid #555; padding:2.5px 2px; font-size:6.5pt; font-weight:700; text-align:center; vertical-align:middle; white-space:normal; word-break:break-word; line-height:1.2; }
  tbody td  { border:1px solid #bbb; padding:2px 2.5px; font-size:7pt; text-align:center; vertical-align:middle; word-break:break-word; line-height:1.2; }
  tbody td.l { text-align:left; }
  tbody td.r { text-align:right; font-weight:600; }
  tbody tr:nth-child(even) td { background:#f5f5f5; }
  tfoot td { font-weight:900; background:#e0e0e0; border:1.5px solid #444; padding:2px 3px; font-size:7.5pt; }

  /* COL WIDTHS ‚Äî total 277mm */
  .c0  { width:7mm; }
  .c1  { width:45mm; }
  .c2  { width:20mm; }
  .c3  { width:26mm; }
  .c4  { width:22mm; }
  .c5  { width:22mm; }
  .c6  { width:16mm; }
  .c7  { width:22mm; }
  .c8  { width:20mm; }
  .c9  { width:25mm; }
  .c10 { width:22mm; }

  /* BELOW BOX */
  .note { font-size:6.5pt; color:#444; margin-top:2mm; font-style:italic; }
  .sigs { display:flex; justify-content:space-between; margin-top:6mm; gap:8mm; }
  .sig  { flex:1; }
  .sig-lbl  { font-size:7.5pt; font-weight:700; margin-bottom:5mm; }
  .sig-line { border-top:1.5px solid #000; width:100%; }
  .footer   { text-align:right; margin-top:2mm; font-size:6.5pt; color:#888; font-style:italic; }
</style>
</head><body>
<div class="page">

  <div class="hdr">
    <div class="hdr-left">
      <div class="logo-row"><img src="data:image/png;base64,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" style="height:12mm;width:auto;display:block;" alt="TOSHIBA LOGISTICS"></div>
      <div class="ft-row"><span class="ft-lbl">From :</span><span class="ft-val">TPC</span></div>
      <div class="ft-row"><span class="ft-lbl">To &nbsp;&nbsp;:</span><span class="ft-val">TLGP</span></div>
    </div>
    <div class="hdr-center"><div class="slip-title">TRANSFER SLIP</div></div>
    <div class="hdr-right">
      <div class="ctrl-row"><span class="ctrl-lbl">TS Control No:</span><span class="ctrl-val">${tsno}</span></div>
    </div>
  </div>

  <div class="box">
    <div class="date-row"><span style="font-weight:700;">DATE:</span><span class="date-val">&nbsp;${slipDate}</span></div>
    <table>
      <colgroup>
        <col class="c0"><col class="c1"><col class="c2"><col class="c3"><col class="c4">
        <col class="c5"><col class="c6"><col class="c7"><col class="c8"><col class="c9"><col class="c10">
      </colgroup>
      <thead><tr>
        <th class="c0">NO.</th>
        <th class="c1">PRODUCT / ITEM CODE</th>
        <th class="c2">LOCATION</th>
        <th class="c3">LOT #</th>
        <th class="c4">QUALITY STATUS</th>
        <th class="c5">QUANTITY</th>
        <th class="c6">NO. OF CASES</th>
        <th class="c7">EXPIRY DATE</th>
        <th class="c8">PALLET REF.</th>
        <th class="c9">REMARKS</th>
        <th class="c10">TLGP LOCATION</th>
      </tr></thead>
      <tbody>${tbody}</tbody>
      <tfoot><tr>
        <td colspan="5" class="r" style="padding-right:4px;">TOTAL</td>
        <td class="r">${totalQty.toLocaleString()}</td>
        <td class="r">${totalCases||''}</td>
        <td colspan="4"></td>
      </tr></tfoot>
    </table>
  </div>

  <p class="note">NOTE: No. of Cases and Expiry date is applicable only for Finished Product.</p>
  <div class="sigs">
    <div class="sig"><div class="sig-lbl">PREPARED BY:</div><div class="sig-line"></div></div>
    <div class="sig"><div class="sig-lbl">CHECKED BY:</div><div class="sig-line"></div></div>
    <div class="sig"><div class="sig-lbl">STORED BY:</div><div class="sig-line"></div></div>
  </div>
  <div class="footer">PLC-TPC-031-R00 &nbsp;|&nbsp; Printed: ${new Date().toLocaleString('en-GB')}</div>
</div>
<script>window.onload=function(){ window.print(); window.onafterprint=function(){ window.close(); }; }<\/script>
</body></html>`;

    const pw = window.open('','_blank','width=900,height=600,scrollbars=yes');
    pw.document.write(html);
    pw.document.close();
}
function closePrintSlip(){
    document.getElementById('transfer-print-area').style.display='none';
    document.getElementById('print-close-transfer').style.display='none';
}

/* ‚îÄ‚îÄ Print All Storing Tags ‚îÄ‚îÄ */
function printAllStoringTags(){
    const rows=ROWS.map(row=>{ const d={}; getActiveCols().forEach((c,ci)=>d[c.key]=getCellVal(row.ri,ci)); return d; }).filter(r=>r.loc&&r.cod);
    if(!rows.length){ alert('‚ùå No valid rows.'); return; }
    const slipDate=document.getElementById('slip-date').value||new Date().toLocaleDateString('en-GB');
    const pages=rows.map(r=>{
        const cod=r.cod||'‚Äî',lot=r.lot||'‚Äî',loc=r.loc||'‚Äî';
        const qty=(parseFloat(r.qty)||0).toLocaleString();
        let dt=r.dat||slipDate||'‚Äî';
        try{ if(dt&&dt.includes('-')){ const[y,m,d]=dt.split('-'); dt=m+'/'+d+'/'+y; } }catch(e){}
        const csz=cod.length>12?Math.max(30,Math.floor(80*10/cod.length)):80;
        const lsz=lot.length>12?Math.max(30,Math.floor(80*10/lot.length)):80;
        const locsz=loc.length>9?60:80;
        return `<div class="tag-page"><div class="tag-company">TOSHIBA LOGISTICS PHILIPPINES CORP.</div><div class="tag-title-row">PALLET IDENTIFICATION TAG</div><div class="tag-field"><div class="tag-field-label">PRODUCT/<br>ITEM CODE:</div><div class="tag-field-value" style="font-size:${csz}pt;">${cod}</div></div><div class="tag-field"><div class="tag-field-label">LOT<br>NUMBER:</div><div class="tag-field-value bold" style="font-size:${lsz}pt;">${lot}</div></div><div class="tag-field"><div class="tag-field-label">QUANTITY :</div><div class="tag-field-value">${qty}</div></div><div class="tag-field"><div class="tag-field-label">LOCATION:</div><div class="tag-field-value" style="font-size:${locsz}pt;">${loc}</div></div><div class="tag-field" style="border-bottom:2.5px solid #000;"><div class="tag-field-label">STORING<br>DATE:</div><div class="tag-field-value">${dt}</div></div><div class="tag-footer"><div class="tag-doc-ref">PLC-TPC-019.R00</div></div></div>`;
    }).join('');
    document.getElementById('transfer-print-area').innerHTML=pages;
    document.getElementById('transfer-print-area').style.display='block';
    document.getElementById('print-close-transfer').style.display='block';
    window.print();
}

window.addEventListener('beforeunload', ()=>saveGridState());

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   INIT
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
(function init(){
    const savedRows = loadGridState();
    setGridTemplate();
    if(savedRows && savedRows.length){
        const ac=getActiveCols();
        savedRows.forEach(d=>createRow(ac.map(c=>d[c.key]!==undefined?String(d[c.key]):'')));
        if(ROWS.length<3) addRows(3);
        showToast('üìÇ Draft restored');
    } else {
        addRows(20);
    }
})();
</script>
</body>
</html>
